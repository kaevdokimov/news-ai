name: Deploy to Production

on:
    push:
        branches: ["main"]
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Login to Docker Registry
              uses: docker/login-action@v2
              with:
                  registry: ${{ vars.DOCKER_REGISTRY }}
                  username: ${{ vars.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and push
              uses: docker/build-push-action@v4
              with:
                  context: .
                  push: true
                  file: .docker/app/DockerfileProduction
                  tags: ${{ vars.DOCKER_REGISTRY }}/${{ vars.DOCKER_USERNAME }}/news-ai:latest
                  cache-from: type=registry,ref=${{ vars.DOCKER_REGISTRY }}/${{ vars.DOCKER_USERNAME }}/news-ai:latest
                  cache-to: type=inline

            - name: Install OpenSSH
              run: |
                  sudo apt-get update
                  sudo apt-get install -y openssh-client

            - name: Setup SSH
              run: |
                  mkdir -p ~/.ssh
                  # Save key directly and clean up any potential issues
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_ecdsa
                  chmod 600 ~/.ssh/id_ecdsa

                  # Configure SSH client
                  echo "Host *" > ~/.ssh/config
                  echo "  StrictHostKeyChecking no" >> ~/.ssh/config
                  echo "  UserKnownHostsFile=/dev/null" >> ~/.ssh/config
                  echo "  IdentityFile ~/.ssh/id_ecdsa" >> ~/.ssh/config
                  chmod 600 ~/.ssh/config

                  # Extended debug information
                  echo "SSH client version:"
                  ssh -V
                  echo "OpenSSL version:"
                  openssl version
                  echo "Key file permissions:"
                  ls -la ~/.ssh/id_ecdsa
                  echo "Key file first line:"
                  head -n1 ~/.ssh/id_ecdsa | grep -v "KEY" || true
                  echo "Key file structure:"
                  grep -c "BEGIN .* PRIVATE KEY" ~/.ssh/id_ecdsa || true
                  grep -c "END .* PRIVATE KEY" ~/.ssh/id_ecdsa || true
                  echo "Attempting key validation:"
                  ssh-keygen -y -f ~/.ssh/id_ecdsa > /dev/null 2>&1 || echo "Invalid key format detected"

            - name: Test SSH connection and deploy to server
              env:
                  COMPOSE_PROJECT_NAME: ${{ vars.COMPOSE_PROJECT_NAME }}
                  APP_ENV: ${{ secrets.APP_ENV }}
                  APP_SECRET: ${{ secrets.APP_SECRET }}
                  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
                  RABBITMQ_DEFAULT_PASS: ${{ secrets.RABBITMQ_DEFAULT_PASS }}
                  RABBITMQ_SERVER_VERSION: ${{ vars.RABBITMQ_SERVER_VERSION }}
                  RABBITMQ_USER: ${{ secrets.RABBITMQ_USER }}
                  RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
                  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
              run: |
                  echo "Testing SSH connection with verbose output..."
                  ssh -vvv -o "BatchMode=yes" -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "echo 'SSH connection successful'"

                  # Proceed with deployment
                  scp -P ${{ secrets.SSH_PORT }} compose.yaml ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH }}/

                  ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "cd ${{ secrets.DEPLOY_PATH }} && \
                    echo 'APP_ENV=${{ secrets.APP_ENV }}' > .env.local && \
                    echo 'APP_SECRET=${{ secrets.APP_SECRET }}' >> .env.local && \
                    echo 'POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}' >> .env.local && \
                    echo 'RABBITMQ_DEFAULT_PASS=${{ secrets.RABBITMQ_DEFAULT_PASS }}' >> .env.local && \
                    echo 'RABBITMQ_SERVER_VERSION=${{ vars.RABBITMQ_SERVER_VERSION }}' >> .env.local && \
                    echo 'RABBITMQ_USER=${{ secrets.RABBITMQ_USER }}' >> .env.local && \
                    echo 'RABBITMQ_PASSWORD=${{ secrets.RABBITMQ_PASSWORD }}' >> .env.local && \
                    echo 'COMPOSE_PROJECT_NAME=${{ vars.COMPOSE_PROJECT_NAME }}' >> .env.local && \
                    docker compose pull && \
                    docker compose up -d && \
                    docker compose exec -T app php bin/console doctrine:migrations:migrate --no-interaction && \
                    docker compose exec -T app php bin/console cache:clear"
