name: Deploy to Production

on:
    push:
        branches: ["main"]
    workflow_dispatch:

permissions:
    contents: read
    packages: write

env:
    DOCKER_IMAGE: ghcr.io/kaevdokimov/news-ai
    DOCKER_TAG: ${{ github.sha }}

jobs:
    deploy:
        name: Deploy to Production
        runs-on: ubuntu-latest
        environment: production
        steps:
            - uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Login to GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v4
              with:
                  context: .
                  file: .docker/app/DockerfileProduction
                  push: true
                  tags: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Install SSH key
              uses: webfactory/ssh-agent@v0.7.0
              with:
                  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

            - name: Setup environment
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
                  chmod 600 ~/.ssh/known_hosts

            - name: Deploy to server
              env:
                  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
                  SSH_USER: ${{ secrets.SSH_USERNAME }}
                  SSH_HOST: ${{ secrets.SSH_HOST }}
                  SSH_PORT: ${{ secrets.SSH_PORT }}
                  DOCKER_IMAGE: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
              run: |
                  # Create necessary directories
                  ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
                    set -e
                    mkdir -p $DEPLOY_PATH/{.docker/nginx,certbot/{conf,www},config,public}
                  "

                  # Copy configuration files
                  rsync -avz -e "ssh -p $SSH_PORT" \
                    --exclude='.git' \
                    --exclude='node_modules' \
                    --exclude='var' \
                    --exclude='vendor' \
                    .docker/nginx/default-production.conf \
                    $SSH_USER@$SSH_HOST:$DEPLOY_PATH/.docker/nginx/

                  rsync -avz -e "ssh -p $SSH_PORT" \
                    compose-production.yaml \
                    $SSH_USER@$SSH_HOST:$DEPLOY_PATH/

                  rsync -avz -e "ssh -p $SSH_PORT" \
                    --exclude='.env.local' \
                    --exclude='.env.test' \
                    .env.prod \
                    $SSH_USER@$SSH_HOST:$DEPLOY_PATH/.env

                  rsync -avz -e "ssh -p $SSH_PORT" \
                    --delete \
                    config/packages/ \
                    $SSH_USER@$SSH_HOST:$DEPLOY_PATH/config/packages/

                  rsync -avz -e "ssh -p $SSH_PORT" \
                    --delete \
                    public/ \
                    $SSH_USER@$SSH_HOST:$DEPLOY_PATH/public/

                  # Execute deployment commands
                  ssh -p $SSH_PORT $SSH_USER@$SSH_HOST "
                    set -e
                    cd $DEPLOY_PATH

                    # Login to GitHub Container Registry
                    echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin

                    # Stop and remove existing containers
                    docker compose -f compose-production.yaml down || true

                    # Pull new images and start services
                    docker compose -f compose-production.yaml pull
                    docker compose -f compose-production.yaml up -d --remove-orphans

                    # Run database migrations
                    docker compose -f compose-production.yaml exec -T news_ai_app php bin/console doctrine:migrations:migrate -n --allow-no-migration

                    # Clear and warmup cache
                    docker compose -f compose-production.yaml exec -T news_ai_app php bin/console cache:clear --no-warmup
                    docker compose -f compose-production.yaml exec -T news_ai_app php bin/console cache:warmup

                    # Set proper permissions
                    docker compose -f compose-production.yaml exec -T news_ai_app chown -R www-data:www-data /var/www/app/var
                    docker compose -f compose-production.yaml exec -T news_ai_app chmod -R 0777 /var/www/app/var

                    # Check if certificates exist, if not generate self-signed ones
                    if [ ! -f '$DEPLOY_PATH/certbot/conf/live/signalscan.ru/fullchain.pem' ]; then
                      echo 'Generating self-signed certificates...'
                      mkdir -p $DEPLOY_PATH/certbot/conf/live/signalscan.ru
                      openssl req -x509 -nodes -newkey rsa:2048 -days 1 \
                        -keyout '$DEPLOY_PATH/certbot/conf/live/signalscan.ru/privkey.pem' \
                        -out '$DEPLOY_PATH/certbot/conf/live/signalscan.ru/fullchain.pem' \
                        -subj '/CN=localhost'
                    fi

                    # Restart nginx to apply new certificates
                    docker compose -f compose-production.yaml restart news_ai_nginx

                    # Clean up old images
                    docker image prune -af --filter 'until=24h'
                  "

            - name: Verify deployment
              run: |
                  curl -sSf https://signalscan.ru/health > /dev/null
                  echo 'âœ… Deployment successful!'
