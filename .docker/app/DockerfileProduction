FROM ghcr.io/kaevdokimov/php:php84

# Метаданные
LABEL maintainer="kaevdokimov"
LABEL description="News AI Production Image"

# Аргументы сборки
ARG APP_DIR=/var/www/app

# Переменные окружения
ENV APP_DIR=${APP_DIR} \
    APP_ENV=prod \
    APP_DEBUG=0 \
    COMPOSER_ALLOW_SUPERUSER=1 \
    COMPOSER_MEMORY_LIMIT=-1

# Установка зависимостей и настройка
USER root

RUN set -eux; \
    apk update --no-cache; \
    apk add --no-cache \
        git \
        unzip \
        curl \
        bash \
        supervisor \
        dcron \
        su-exec \
        netcat-openbsd \
        openssl \
        tzdata; \
    rm -rf /var/cache/apk/*; \
    curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer --quiet; \
    composer --version; \
    mkdir -p ${APP_DIR} && \
    chown -R www-data:www-data ${APP_DIR}

WORKDIR ${APP_DIR}

# Копируем только composer файлы сначала для кэширования
COPY --chown=www-data:www-data composer.* symfony.lock ./

# Установка зависимостей
RUN composer install --prefer-dist --no-scripts --no-progress --optimize-autoloader --no-interaction

# Копируем все файлы приложения
COPY --chown=www-data:www-data . .

# Удаляем ненужные файлы
RUN rm -rf .docker/ .github/ .git/ docker-compose* .env* README.md

# Копирование конфигураций
COPY .docker/app/php/fpm/php.ini /usr/local/etc/php/php.ini
COPY --chown=www-data:www-data .docker/app/cmd.sh .docker/app/cmd.sh
COPY --chown=www-data:www-data .docker/app/supervisord.conf /etc/supervisor/conf.d/supervisord.conf
COPY --chown=www-data:www-data .docker/app/entrypoint.sh /entrypoint.sh

# Делаем entrypoint исполняемым
RUN chmod +x /entrypoint.sh

# Установка зависимостей
RUN set -eux; \
    # Создаем необходимые директории
    mkdir -p /var/log/supervisord /var/log/cron /tmp/composer-cache/files var \
    # Установка зависимостей (без скриптов, они выполнятся в entrypoint)
    && composer install --prefer-dist --no-dev --no-scripts --no-progress --optimize-autoloader --no-interaction \
    # Очистка кеша
    && composer clear-cache \
    # Установка прав
    && chown -R www-data:www-data var \
    && chmod -R 0777 var \
    # Установка прав для логов
    && chown -R www-data:www-data /var/log/supervisord /var/log/cron \
    && chmod -R 0777 /var/log/supervisord /var/log/cron \
    # Очистка временных файлов
    && rm -rf /tmp/* /var/tmp/* /usr/local/share/.cache/* /root/.composer/*

# Настройка прав и директорий
RUN set -eux; \
    mkdir -p public/uploads \
    && chown -R www-data:www-data public/uploads \
    && chmod -R 0777 public/uploads \
    # Очистка кеша
    && php bin/console cache:warmup \
    && chown -R www-data:www-data var/cache var/log; \
    # Настройка cron
    echo "*/5 * * * * /usr/local/bin/php /var/www/app/bin/console app:parse-rss >> /var/log/cron/cron.log 2>&1" > /etc/crontabs/root

# Здоровье контейнера
HEALTHCHECK --interval=30s --timeout=3s --start-period=1m \
    CMD curl -f http://localhost/health || exit 1

# Точка входа и команда по умолчанию
ENTRYPOINT ["/entrypoint.sh"]
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]

# Переключаемся на непривилегированного пользователя
USER www-data
