FROM ghcr.io/kaevdokimov/php:php84

# Build arguments
ARG APP_DIR=/var/www/app

# Environment variables
ENV APP_DIR=${APP_DIR} \
    APP_ENV=prod \
    APP_DEBUG=0

# Create app directory
RUN mkdir -p ${APP_DIR} && chown www-data:www-data ${APP_DIR}

# Copy only necessary files
COPY --chown=www-data:www-data \
    composer.json \
    composer.lock \
    symfony.lock \
    ${APP_DIR}/

# Install Composer
COPY --from=composer:2.6 /usr/bin/composer /usr/bin/composer

# Install production dependencies
WORKDIR ${APP_DIR}
RUN composer install --prefer-dist --no-dev --no-scripts --no-progress --optimize-autoloader --no-interaction

# Copy remaining application files
COPY --chown=www-data:www-data \
    bin/ \
    config/ \
    migrations/ \
    public/ \
    src/ \
    templates/ \
    ${APP_DIR}/

# Copy PHP configuration
COPY .docker/app/php/fpm/php.ini /usr/local/etc/php/php.ini

# Set working directory and permissions
WORKDIR ${APP_DIR}
RUN chmod +x ${APP_DIR}/.docker/app/cmd.sh

# Switch to non-root user
USER www-data

# Run the application
CMD ["/var/www/app/.docker/app/cmd.sh"]
