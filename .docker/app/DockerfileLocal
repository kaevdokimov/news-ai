FROM ghcr.io/kaevdokimov/php:6f02992169bf6d68cfc032291d2016ed7fedba96

# Build arguments
ARG APP_DIR=/var/www/app

# Environment variables
ENV APP_DIR=${APP_DIR}

# Copy application files
COPY --chown=www-data:staff ./ ${APP_DIR}
COPY ./.docker/app/php/fpm/php.ini /usr/local/etc/php/php.ini

# Setup cron for news parsing
RUN echo "*/5 * * * *  php /var/www/app/bin/console app:parse-rss --async" | crontab - && \
    mkdir -p /var/log && \
    touch /var/log/news_parsing.log && \
    chown www-data:staff /var/log/news_parsing.log

# Cleanup and permissions
RUN rm -rf ${APP_DIR}/var/cache/* /var/www/app/var/log/* && \
    chmod +x ${APP_DIR}/.docker/app/cmd.sh && \
    chown -R www-data:staff /var/www

WORKDIR ${APP_DIR}
USER www-data
CMD ["/var/www/app/.docker/app/cmd.sh"]
